name: Claude Code Review

on:
    pull_request:
        types: [opened, synchronize, reopened]
    # Allow manual triggers for re-running reviews
    workflow_dispatch:

permissions:
    contents: read
    pull-requests: write
    issues: write
    id-token: write

jobs:
    claude-review:
        name: Review PR with Claude
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Claude Code Review
              uses: anthropics/claude-code-action@v1
              with:
                  anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                  prompt: |
                      /review

                      Review this PR following @CLAUDE.md and @sdks/node/STYLEGUIDE.md. Focus on:

                      **Architecture (requires AI judgment):**
                      - Import boundaries: `runtime/**` â†› `domains/**`, no cross-domain `internal/**` imports
                      - ACL violations: duplicate `/generated/**` imports, non-ACL files importing generated types
                      - API design: type safety, interface contracts, error handling patterns

                      **ACL Patterns (if `*.acl.ts` changed):**
                      - Explicit `implements` over type aliases, proper naming (`VerbResourceRequest`, `ResourceResponse`)
                      - Enum pattern: `const X = {...} as const satisfies Record<keyof typeof GenEnum, string>`

                      **Code Quality:**
                      - Logic errors, edge cases, performance issues
                      - Test coverage gaps (E2E for features, unit for services/runtime)
                      - Security concerns, PII in logs

                      **Commit & Documentation:**
                      - Conventional commit scope and type correctness
                      - Breaking changes properly flagged (`!`)
                      - Missing documentation for public APIs
                  claude_args: "--max-turns 10 --model claude-sonnet-4-5-20250929"
